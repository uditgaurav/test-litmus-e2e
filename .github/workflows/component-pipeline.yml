---
name: Component-Pipeline
on:
  push:
    branches: [master]
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'     
        required: true
        default: 'warning'
    
jobs:
  Setup Litmus Infra:
    container: 
      image: litmuschaos/litmus-e2e:ci
      volumes:
        - /home/ubuntu/.kube:/root/.kube
        - /etc/kubernetes:/etc/kubernetes
    runs-on: self-hosted
    steps:
      - name: Litmus Infra Setup In Cluster-1
        env:
          KUBECONFIG: /root/.kube/config
        run: make build-litmus
        
  Setup App Deployment:
    needs:  Setup Litmus Infra
    container: 
      image: litmuschaos/litmus-e2e:ci
      volumes:
        - /home/ubuntu/.kube:/root/.kube
        - /etc/kubernetes:/etc/kubernetes      
    runs-on: self-hosted
    steps:
      - name: Deploy App In Cluster-1
        env:
          KUBECONFIG: /root/.kube/config
        run: make build-litmus        

      - name: Liveness In Cluster-1
        env:
          KUBECONFIG: /root/.kube/config
        run: make build-litmus        

      - name: Auxiliary App In Cluster-1
        env:
          KUBECONFIG: /root/.kube/config
        run: make build-litmus
        
  Component Test:
    needs:
      - Setup Litmus Infra
      - Setup App Deployment   
    container: 
      image: litmuschaos/litmus-e2e:ci
      volumes:
        - /home/ubuntu/.kube:/root/.kube
        - /etc/kubernetes:/etc/kubernetes
    runs-on: self-hosted
    steps:
      - name: TCID-EC2-GENERIC-OPERATOR-RECONCILE-RESILIENCY
        run: make operator-reconcile-resiliency-check
        
  App Cleanup In Cluster-1:
    needs:
      - Component Test
      - Setup App Deployment
    container: 
      image: litmuschaos/litmus-e2e:ci
      volumes:
        - /home/ubuntu/.kube:/root/.kube
        - /etc/kubernetes:/etc/kubernetes
    runs-on: self-hosted
    steps:
      - name: Application Cleanup
        run: make app-cleanup
               
  Litmus Cleanup In Cluster-1:
    needs:
      - App Cleanup In Cluster-1
      - Component Test
      - Setup Litmus Infra
    container: 
      image: litmuschaos/litmus-e2e:ci
      volumes:
        - /home/ubuntu/.kube:/root/.kube
        - /etc/kubernetes:/etc/kubernetes
    runs-on: self-hosted
    steps:
      - name: Application Cleanup
        run: make litmus-cleanup
               
      
